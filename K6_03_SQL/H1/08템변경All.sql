---------------------------------------------------------------
/*
gameid=xxx						'SangSang'
password=xxx					'049000s1i0n7t8445289'
ccharacter=xxx(반드시존재)		0
cap=xxx(보정해줌)				101
cupper=xxx(보정해줌)			201
cunder=xxx(보정해줌)			301
bat=xxx(보정해줌)				401
glasses=xxx(해제 -1)			502
wing=xxx(해제 -1)				612
tail=xxx(해제 -1)				700
pet=xxx(해제 -1)				5001
stadium=xxx(반드시존재)			801


exec spu_ItemChangeAll 'SangSangx', '049000s1i0n7t8445289', 0, 101, 201, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '49000s1i0n7t8445289', 0, 101, 201, 301, 401, 502, 612, 700, 5001, 801, -1

exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 101, 201, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 103, 201, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, 500, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, 510, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, 600, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, 700, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 701, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 702, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, -1, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 5000, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, -1, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 6000, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 6000, 800, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 6000, -1, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 102, 202, 301, 427, -1, -1, 800, 6000, 801, -1

exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 1, 101, 201, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 1, 124, 224, 324, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 1, 130, 224, 324, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 2, 124, 224, 324, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'DD6', '049000s1i0n7t8445289', 3, 124, 224, 324, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 1, 101, 201, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 101, 201, 301, 401, 502, 612, 700, 5001, 801, -1
exec spu_ItemChangeAll 'SangSang', '049000s1i0n7t8445289', 0, 100, 200, 300, 400, -1, -1, -1, -1, 800, -1
*/

IF OBJECT_ID ( 'dbo.spu_ItemChangeAll', 'P' ) IS NOT NULL 
    DROP PROCEDURE dbo.spu_ItemChangeAll;
GO 

------------------------------------------------
--	1. 프로시져 생성
------------------------------------------------
create procedure dbo.spu_ItemChangeAll
	@gameid_									varchar(20),
	@password_									varchar(20),
	@ccharacter_								int,
	@cap_										int,
	@cupper_									int,
	@cunder_									int,
	@bat_										int,
	@glasses_									int,
	@wing_										int,
	@tail_										int,
	@pet_										int,
	@stadium_									int,
	@nResult_									int					OUTPUT
	WITH ENCRYPTION -- 프로시져를 암호화함.
as	
	------------------------------------------------
	--	2-1. 코드값자리
	------------------------------------------------	
	-- 일반값
	declare @RESULT_SUCCESS						int				set @RESULT_SUCCESS						=  1			
	declare @RESULT_ERROR						int				set @RESULT_ERROR						= -1	
	
	--가입 오류.
	declare @RESULT_ERROR_ID_DUPLICATE			int				set @RESULT_ERROR_ID_DUPLICATE			= -2			
	declare @RESULT_ERROR_EMAIL_DUPLICATE		int				set @RESULT_ERROR_EMAIL_DUPLICATE		= -3
	
	-- 로그인 오류. 
	declare @RESULT_ERROR_BLOCK_USER 			int				set @RESULT_ERROR_BLOCK_USER			= -11			--블럭유저 > 팝업처리후 인트로로 빼버린다.
	declare @RESULT_ERROR_DELETED_USER 			int				set @RESULT_ERROR_DELETED_USER			= -12			--삭제유저 > 팝업처리후 인트로로 빼버린다.
	declare @RESULT_ERROR_NOT_FOUND_GAMEID		int				set @RESULT_ERROR_NOT_FOUND_GAMEID		= -13			--해당유저를 찾지 못함
	declare @RESULT_ERROR_NOT_FOUND_PASSWORD	int				set @RESULT_ERROR_NOT_FOUND_PASSWORD	= -17			
	declare @RESULT_ERROR_SERVER_CHECKING		int				set @RESULT_ERROR_SERVER_CHECKING		= -14			--서버를 점검하고 있다.
	declare @RESULT_NEWVERION_CLIENT_DOWNLOAD 	int				set @RESULT_NEWVERION_CLIENT_DOWNLOAD	= -15			--신버젼이 나왔다 > 새버젼을 받아라 메세지 처리후 링크처리.
	declare @RESULT_NEWVERION_FILE_DOWNLOAD 	int				set @RESULT_NEWVERION_FILE_DOWNLOAD		= -16			--신버젼이 나왔다 > 새버젼을 받아라 메세지 처리후 종료.
	                                                                                                         			
	-- 게임중에 부족.
	declare @RESULT_ERROR_ACTION_LACK			int				set @RESULT_ERROR_ACTION_LACK			= -20			--행동력이 부족하다.
	declare @RESULT_ERROR_SILVERBALL_LACK		int				set @RESULT_ERROR_SILVERBALL_LACK		= -21			--실버가 부족하다.
	declare @RESULT_ERROR_GOLDBALL_LACK			int				set @RESULT_ERROR_GOLDBALL_LACK			= -22			--골드가 부족하다.
	declare @RESULT_ERROR_ITEM_LACK				int				set @RESULT_ERROR_ITEM_LACK				= -23			--아이템이부족하다.
	declare @RESULT_ERROR_COIN_LACK				int				set @RESULT_ERROR_COIN_LACK				= -24			--코인잉 부족하다.

	-- 아이템 구매, 변경.                                                                                                   			
	declare @RESULT_ERROR_BUY_ALREADY			int				set @RESULT_ERROR_BUY_ALREADY			= -31			--이미 구매했습니다.
	declare @RESULT_ERROR_NOT_HAVE				int				set @RESULT_ERROR_NOT_HAVE				= -32			--보유하지 않고 있다.
	declare @RESULT_ERROR_UPGRADE_CANNT			int				set @RESULT_ERROR_UPGRADE_CANNT			= -33			--업그레이드를 할수 없다.						
	declare @RESULT_ERROR_UPGRADE_FAIL			int				set @RESULT_ERROR_UPGRADE_FAIL			= -34			--업그레이드 실패.
	declare @RESULT_ERROR_UPGRADE_FULL			int				set @RESULT_ERROR_UPGRADE_FULL			= -35			--업그레이드가 풀로되었다.
	declare @RESULT_ERROR_ITEM_EXPIRE			int				set @RESULT_ERROR_ITEM_EXPIRE			= -36			--아이템이 만기 되었다.
	declare @RESULT_ERROR_ITEM_NOSALE_KIND		int				set @RESULT_ERROR_ITEM_NOSALE_KIND		= -37			--판매하지 않는 아이템
	declare @RESULT_ERROR_ITEM_PERMANENT_ALREADY int			set @RESULT_ERROR_ITEM_PERMANENT_ALREADY = -38			-- 영구템을 이미 구해했습니다.
	declare @RESULT_ERROR_ITEM_NOCHANGE_KIND	int				set @RESULT_ERROR_ITEM_NOCHANGE_KIND	= -39			--자체변경불가템
	declare @RESULT_ERROR_UPGRADE_NOBRANCH		int 			set @RESULT_ERROR_UPGRADE_NOBRANCH 		= -60			-- 비지정된 브렌치문.
	declare @RESULT_ERROR_NOT_WEAR				int 			set @RESULT_ERROR_NOT_WEAR 				= -61			-- 미장착된 상태 
	declare @RESULT_ERROR_ITEM_STRIP_CANNT_KIND	int				set @RESULT_ERROR_ITEM_STRIP_CANNT_KIND	= -62			--해제불가부위입니다.
	

	-- 캐쉬구매.
	declare @RESULT_ERROR_CASH_COPY				int				set @RESULT_ERROR_CASH_COPY				= -40			
	declare @RESULT_ERROR_CASH_OVER				int				set @RESULT_ERROR_CASH_OVER				= -41			
	declare @RESULT_ERROR_MONTH_OVER			int				set @RESULT_ERROR_MONTH_OVER			= -42			--한달동안 구매한도를 검사

	-- 아이템선물
	declare @RESULT_ERROR_NOT_FOUND_ITEMCODE	int				set @RESULT_ERROR_NOT_FOUND_ITEMCODE	= -50			-- 아이템코드못찾음
	declare @RESULT_ERROR_GIFTITEM_NOT_FOUND	int				set @RESULT_ERROR_GIFTITEM_NOT_FOUND	= -51			-- 선물아이템을 못찾음
	declare @RESULT_ERROR_GIFTITEM_ALREADY_GAIN	int				set @RESULT_ERROR_GIFTITEM_ALREADY_GAIN	= -52			-- 선물을 이미 가져감

	------------------------------------------------
	--	2-2. 상태값
	------------------------------------------------	
	-- 상태값.
	declare @BLOCK_STATE_NO						int				set	@BLOCK_STATE_NO						= 0				-- 블럭상태아님
	declare @BLOCK_STATE_YES					int				set	@BLOCK_STATE_YES					= 1				-- 블럭상태
	declare @DELETE_STATE_NO					int				set	@DELETE_STATE_NO					= 0				-- 삭제상태아님
	declare @DELETE_STATE_YES					int				set	@DELETE_STATE_YES					= 1				-- 삭제상태

	-- 구매처코드
	declare @MARKET_SKT							int				set @MARKET_SKT							= 1
	declare @MARKET_KT							int				set @MARKET_KT							= 2
	declare @MARKET_LGT							int				set @MARKET_LGT							= 3
	declare @MARKET_FACEBOOK					int				set @MARKET_FACEBOOK					= 4
	declare @MARKET_GOOGLE						int				set @MARKET_GOOGLE						= 5

	-- 시스템 체킹
	declare @SYSCHECK_NON						int				set @SYSCHECK_NON						= 0
	declare @SYSCHECK_YES						int				set @SYSCHECK_YES						= 1

	-- 선물가져가기
	declare @GAINSTATE_NON						int				set @GAINSTATE_NON						= 0
	declare @GAINSTATE_YES						int				set @GAINSTATE_YES						= 1
	
	-- 아이템파트이름
	declare @ITEM_KIND_CHARACTER				int 			set @ITEM_KIND_CHARACTER				= 0
	declare @ITEM_KIND_FACE						int 			set @ITEM_KIND_FACE						= 1			-- 판매템아님
	declare @ITEM_KIND_CAP						int 			set @ITEM_KIND_CAP						= 2
	declare @ITEM_KIND_UPPER					int 			set @ITEM_KIND_UPPER					= 4
	declare @ITEM_KIND_UNDER					int 			set @ITEM_KIND_UNDER					= 5
	declare @ITEM_KIND_BAT						int 			set @ITEM_KIND_BAT						= 6
	declare @ITEM_KIND_GLASSES					int 			set @ITEM_KIND_GLASSES					= 7
	declare @ITEM_KIND_WING						int 			set @ITEM_KIND_WING						= 8
	declare @ITEM_KIND_TAIL						int 			set @ITEM_KIND_TAIL						= 9
	declare @ITEM_KIND_STADIUM					int 			set @ITEM_KIND_STADIUM					= 100
	declare @ITEM_KIND_CUSTOMIZE				int 			set @ITEM_KIND_CUSTOMIZE					= 22		-- 판매방식이 다름
	declare @ITEM_KIND_PET						int 			set @ITEM_KIND_PET						= 80
	declare @ITEM_KIND_BATTLEITEM				int 			set @ITEM_KIND_BATTLEITEM				= 90
	declare @ITEM_KIND_SYSTEMETC				int 			set @ITEM_KIND_SYSTEMETC				= 99
	
	-- 기타 정의값
	declare @ITEM_PERMANENT_START_DAY			datetime		set @ITEM_PERMANENT_START_DAY			= '2012-01-01'	-- 영구템시작
	declare @ITEM_PERMANENT_ADD_YEAR			int				set @ITEM_PERMANENT_ADD_YEAR			= 50			-- 영구템기간
	declare @ITEM_PERIOD_PERMANENT				int 			set @ITEM_PERIOD_PERMANENT				= -1			-- 테이블에 -1이라 기록됨
	declare @ITEM_CHAR_CUSTOMIZE_INIT			varchar(128)	set @ITEM_CHAR_CUSTOMIZE_INIT			= '1'

	--아이템만기
	declare @ITEM_EXPIRE_STATE_NO				int 			set @ITEM_EXPIRE_STATE_NO				= 0			
	declare @ITEM_EXPIRE_STATE_YES				int				set @ITEM_EXPIRE_STATE_YES				= 1
	
	-- 변경모드
	declare @ITEM_WEAR_MODE_PUTON						int 	set @ITEM_WEAR_MODE_PUTON		= 1
	declare @ITEM_WEAR_MODE_STRIP						int 	set @ITEM_WEAR_MODE_STRIP		= -1

	------------------------------------------------
	--	2-3. 내부사용 변수
	------------------------------------------------
	declare @comment							varchar(80)
	declare @gameid								varchar(20)
	declare @password							varchar(20)

Begin
	------------------------------------------------
	--	3-1. 초기화
	------------------------------------------------
	set nocount on
	
	------------------------------------------------
	--	3-2. 연산수행
	------------------------------------------------
	declare @ccharacter		int,			@face			int,		@cap				int, 
			@cupper			int,			@cunder			int,		@bat				int, 
			@glasses		int,			@wing			int,		@tail				int,
			@pet			int,
			@stadium		int
	declare @customize		varchar(128)
	
	declare @ccharacterBase	int,			@faceBase		int,		@capBase			int, 
			@cupperBase		int,			@cunderBase		int,		@batBase			int, 
			@itemkindBase	int
	declare @partBase		int
	declare @itemkind		int
	declare @bChangeChar 	int
			


	------------------------------------------------
	-- 유저(tUserMaster) > 각파트정보
	--select 'DEBUG 현재유저정보', ccharacter, face, cap, cupper, cunder, bat, glasses, wing, tail, pet, stadium, customize from dbo.tUserMaster where gameid = @gameid_
	------------------------------------------------
	select	@gameid = gameid,			@password = password,
			@ccharacter = ccharacter,	@face = face,				@cap = cap,
			@cupper = cupper,			@cunder	= cunder,			@bat = bat,
			@glasses = glasses,			@wing = wing,				@tail = tail,
			@pet = pet,
			@stadium = stadium,
			@customize = customize
	from dbo.tUserMaster where gameid = @gameid_
	
	
	
	------------------------------------------------
	-- 유저 유효성 검사
	--select 'DEBUG 유저유효성 검사'
	------------------------------------------------		
	if(isnull(@gameid, '') = '')
		begin
			set @nResult_ = @RESULT_ERROR_NOT_FOUND_GAMEID
			select @nResult_ rtn, '템변경, 해제 > 아이디틀림(무시하세요).'
			return
		end
	else if(@password != @password_)
		begin
			set @nResult_ = @RESULT_ERROR_NOT_FOUND_PASSWORD
			select @nResult_ rtn, '템변경, 해제 > 패스워드틀림(무시하세요.)'
			return
		end
		
		
	
	------------------------------------------------
	-- 캐릭터, 얼굴 변경, 커스터마이징 
	--select 'DEBUG 1 캐릭터변경, 얼굴, 커스터마이징 Original:' + ltrim(rtrim(@ccharacter)) + ' Input:' + ltrim(rtrim(@ccharacter_))
	------------------------------------------------
	set @bChangeChar = 0
	if(@ccharacter = @ccharacter_)
		begin
			set @ccharacter = @ccharacter_		--이것없으면 오류난다.
			--select 'DEBUG 1-1 캐릭터 동일 > 파트만 변경'
			--select @itemkind = kind, 	
			--	   @faceBase = param1,			@capBase = param2,		@cupperBase = param3,	
			--	   @cunderBase = param4,		@batBase = param5
			--from dbo.tItemInfo where itemcode = @ccharacter	
		end
	else if exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @ccharacter_)
		begin
			--select 'DEBUG 1-2 캐릭터 변경 > 유효한지 검사, 머리사이즈변경'
			set @ccharacter = @ccharacter_
			set @bChangeChar = 1
			
			select @customize = customize from dbo.tUserCustomize where gameid = @gameid_ and itemcode = @ccharacter_
			
			--select @itemkind = kind, 	
			--	   @faceBase = param1,			@capBase = param2,		@cupperBase = param3,	
			--	   @cunderBase = param4,		@batBase = param5
			--from dbo.tItemInfo where itemcode = @ccharacter				
		end
	--else
	--	begin
	--		--select 'DEBUG 1-3 캐릭터 미보유캐릭터 변경할려고해서 원본'
	--		--select @itemkind = kind, 	
	--		--	   @faceBase = param1,			@capBase = param2,		@cupperBase = param3,	
	--		--	   @cunderBase = param4,		@batBase = param5
	--		--from dbo.tItemInfo where itemcode = @ccharacter	
	--	end
	
	select @itemkind = kind, 	
		   @faceBase = param1,			@capBase = param2,		@cupperBase = param3,	
		   @cunderBase = param4,		@batBase = param5
	from dbo.tItemInfo where itemcode = @ccharacter
	set @face = @faceBase
	
	--캐릭터가 바뀌었으므로 기본이 바뀐다.
	if(@bChangeChar = 1)
		begin
			set @cap 		= @capBase
			set @cupper 	= @cupperBase
			set @cunder = @cunderBase
		end
	
	
	--select 'DEBUG 1-99 검색된 기본파트',
	--	   @itemkind  kind, 	
	--	   @ccharacter ccharacter,
	--	   @faceBase  faceBase,			@capBase  capBase,		@cupperBase  cupperBase,	
	--	   @cunderBase  cunderBase,		@batBase  batBase
	
	------------------------------------------------
	-- 모자
	--select 'DEBUG 2 모자 Original:' + ltrim(rtrim(@cap)) + ' Input:' + ltrim(rtrim(@cap_)) + ' Base:' + ltrim(rtrim(@capBase))
	------------------------------------------------
	select @itemkind = kind, 	
			@ccharacterBase = param7,			
			@partBase = param8
	from dbo.tItemInfo where itemcode = @cap_
	if((@itemkind = @ITEM_KIND_CAP) and (@ccharacter = @ccharacterBase))
		begin
			if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @cap_ and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 2-1 모자 변경'
					set @cap = @cap_
				end
			else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @cap and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 2-2 모자 유효'
					set @cap = @cap
				end
			else
				begin
					--select 'DEBUG 2-3 모자 기본1'
					set @cap = @partBase
				end 
		end
	else
		begin
			--select 'DEBUG 2-4 캐릭변경 모자 기본2'
			set @cap = @capBase
		end
	--select 'DEBUG 2-99 모자 ' + ltrim(rtrim(@cap))
		
	------------------------------------------------
	-- 상의
	--select 'DEBUG 3 상의 Original:' + ltrim(rtrim(@cupper)) + ' Input:' + ltrim(rtrim(@cupper_)) + ' Base:' + ltrim(rtrim(@cupperBase))
	------------------------------------------------
	select @itemkind = kind, 	
			@ccharacterBase = param7,			
			@partBase = param8
	from dbo.tItemInfo where itemcode = @cupper_
	if((@itemkind = @ITEM_KIND_UPPER) and (@ccharacter = @ccharacterBase))
		begin
			if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @cupper_ and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 3-1 상의 변경'
					set @cupper = @cupper_
				end
			else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @cupper and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 3-2 상의 착용템 유효'
					set @cupper = @cupper
				end
			else
				begin
					--select 'DEBUG 3-3 상의 기본'
					set @cupper = @partBase
				end 
		end
	else
		begin
			--select 'DEBUG 캐릭변경 3-4 상의 기본2'
			set @cupper = @cupperBase
		end
	--select 'DEBUG 3-99 상의 ' + ltrim(rtrim(@cupper))
		
	
	------------------------------------------------
	-- 하의
	--select 'DEBUG 4 하의 Original:' + ltrim(rtrim(@cunder)) + ' Input:' + ltrim(rtrim(@cunder_)) + ' Base:' + ltrim(rtrim(@cunderBase))
	------------------------------------------------
	select @itemkind = kind, 	
			@ccharacterBase = param7,			
			@partBase = param8
	from dbo.tItemInfo where itemcode = @cunder_
	if((@itemkind = @ITEM_KIND_UNDER) and (@ccharacter = @ccharacterBase))
		begin
			if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @cunder_ and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 4-1 하의 변경'
					set @cunder = @cunder_
				end
			else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @cunder and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 4-2 하의 착용템 유효'
					set @cunder = @cunder
				end
			else
				begin
					--select 'DEBUG 4-3 하의 기본'
					set @cunder = @partBase
				end 
		end
	else
		begin
			--select 'DEBUG 4-4 캐릭변경 하의 기본'
			set @cunder = @cunderBase
		end
	--select 'DEBUG 4-99 하의 ' + ltrim(rtrim(@cunder))
		


	------------------------------------------------
	-- 배트
	--select 'DEBUG 5 배트 Original:' + ltrim(rtrim(@bat)) + ' Input:' + ltrim(rtrim(@bat_)) + ' Base:' + ltrim(rtrim(@batBase))
	------------------------------------------------
	if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @bat_ and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			-- 아이템 카테고리 검사
			--select 'DEBUG 5-1 배트템 보유'
			
			select @itemkind = kind from dbo.tItemInfo where itemcode = @bat_
			if(@itemkind = @ITEM_KIND_BAT)
				begin
					--select 'DEBUG 5-2 배트 교체'
					set @bat = @bat_
				end
			else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @bat and expirestate = @ITEM_EXPIRE_STATE_NO))
				begin
					--select 'DEBUG 5-3 배트 유지'
					set @bat = @bat 		-- 이것없으면 오류난다.
				end
			else
				begin
					--select 'DEBUG 5-4 배트 초기화'
					set @bat = @batBase
				end
		end
	else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @bat and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			--select 'DEBUG 5-5 배트 유지2'
			set @bat = @bat				-- 이것없으면 오류난다.
		end
	else
		begin
			--select 'DEBUG 5-6 캐릭변경 배트 초기화2'
			set @bat = @batBase
		end
	--select 'DEBUG 5-99 배트 ' + ltrim(rtrim(@bat))
		
		
		
	------------------------------------------------
	-- 안경
	--select 'DEBUG 6 안경 Original:' + ltrim(rtrim(@glasses)) + ' Input:' + ltrim(rtrim(@glasses_))
	------------------------------------------------
	if(@glasses_ = -1)
		begin
			--select 'DEBUG 6-1 안경 벗기'
			set @glasses = -1
		end
	else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @glasses_ and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			-- 아이템 카테고리 검사
			select @itemkind = kind from dbo.tItemInfo where itemcode = @glasses_
			if(@itemkind = @ITEM_KIND_GLASSES)
				begin
					--select 'DEBUG 6-2 안경 교체'
					set @glasses = @glasses_
				end
		end
	--select 'DEBUG 6-99 안경 ' + ltrim(rtrim(@glasses))
		
		
		
	------------------------------------------------
	-- 날개
	--select 'DEBUG 7 날개 Original:' + ltrim(rtrim(@wing)) + ' Input:' + ltrim(rtrim(@wing_))
	------------------------------------------------
	if(@wing_ = -1)
		begin
			--select 'DEBUG 7-1 날개 벗기'
			set @wing = -1
		end
	else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @wing_ and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			-- 아이템 카테고리 검사
			select @itemkind = kind from dbo.tItemInfo where itemcode = @wing_
			if(@itemkind = @ITEM_KIND_WING)
				begin
					--select 'DEBUG 7-2 날개 교체'
					set @wing = @wing_
				end
		end
	--select 'DEBUG 7-99 날개 ' + ltrim(rtrim(@wing))
		
		

	------------------------------------------------
	-- 꼬리
	--select 'DEBUG 8 꼬리 Original:' + ltrim(rtrim(@tail)) + ' Input:' + ltrim(rtrim(@tail_))
	------------------------------------------------
	if(@tail_ = -1)
		begin
			--select 'DEBUG 8-1 꼬리 벗기'
			set @tail = -1
		end
	else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @tail_ and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			-- 아이템 카테고리 검사
			select @itemkind = kind from dbo.tItemInfo where itemcode = @tail_
			if(@itemkind = @ITEM_KIND_TAIL)
				begin
					--select 'DEBUG 8-2 꼬리 교체'
					set @tail = @tail_
				end
		end
	--select 'DEBUG 8-99 꼬리 ' + ltrim(rtrim(@tail))
		
		
	------------------------------------------------
	-- 펫
	--select 'DEBUG 9 펫 Original:' + ltrim(rtrim(@pet)) + ' Input:' + ltrim(rtrim(@pet_))
	------------------------------------------------
	if(@pet_ = -1)
		begin
			--select 'DEBUG 9-1 펫 벗기'
			set @pet = -1
		end
	else if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @pet_ and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			-- 아이템 카테고리 검사
			select @itemkind = kind from dbo.tItemInfo where itemcode = @pet_
			if(@itemkind = @ITEM_KIND_PET)
				begin
					--select 'DEBUG 9-2 펫 교체'
					set @pet = @pet_
				end
		end
	--select 'DEBUG 9-99 펫 ' + ltrim(rtrim(@pet))
		
		



	------------------------------------------------
	-- 구장
	--select 'DEBUG 10 구장 Original:' + ltrim(rtrim(@stadium)) + ' Input:' + ltrim(rtrim(@stadium_))
	------------------------------------------------
	if(exists(select top 1 * from dbo.tUserItem where gameid = @gameid_ and itemcode = @stadium_ and expirestate = @ITEM_EXPIRE_STATE_NO))
		begin
			-- 아이템 카테고리 검사
			--select 'DEBUG 10-1 구장템 보유'
			
			select @itemkind = kind from dbo.tItemInfo where itemcode = @stadium_
			if(@itemkind = @ITEM_KIND_STADIUM)
				begin
					--select 'DEBUG 10-2 구장 교체'
					set @stadium = @stadium_
				end
		end		
	--select 'DEBUG 10-99 구장 ' + ltrim(rtrim(@stadium))
		
	------------------------------------------------
	-- 유저정보업데이트
	------------------------------------------------
	update dbo.tUserMaster
	set
		ccharacter 	= @ccharacter,	face 		= @face,		cap = @cap,
		cupper 		= @cupper,		cunder		= @cunder,		bat = @bat,
		glasses 	= @glasses,		wing 		= @wing,		tail = @tail,
		pet 		= @pet,			
		stadium		= @stadium,
		customize	= @customize
	where gameid = @gameid_



	------------------------------------------------
	--	3-3. 결과리턴
	------------------------------------------------
	--select 'DEBUG 유저정보', ccharacter, face, cap, cupper, cunder, bat, glasses, wing, tail, pet, stadium, customize from dbo.tUserMaster where gameid = @gameid_
	set @nResult_ = @RESULT_SUCCESS
	select @nResult_ rtn, '템변경, 해제완료했습니다.'
	
	select * from dbo.tUserMaster where gameid = @gameid_	
	
	set nocount off
End

